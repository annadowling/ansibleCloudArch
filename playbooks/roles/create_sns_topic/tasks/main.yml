# Creates and subscribes to an SNS topic for lambda event triggers
---
- name: Retrieve update-s3-storage-prices Lambda Details
  lambda_facts:
    region: "{{ region }}"
    aws_access_key: "{{ access_key_id }}"
    aws_secret_key: "{{ secret_access_key }}"
    query: all
    function_name: '{{ update_lambda_function }}'
  register: lambda_facts.function

- name: Create Lambda SNS topic
  sns_topic:
    region: "{{ region }}"
    aws_access_key: "{{ access_key_id }}"
    aws_secret_key: "{{ secret_access_key }}"
    name: "{{ price_change_sns_topic_arn }}"
    state: present
    display_name: "{{ sns_topic_name }}"
    delivery_policy:
      http:
        defaultHealthyRetryPolicy:
            minDelayTarget: 2
            maxDelayTarget: 4
            numRetries: 3
            numMaxDelayRetries: 5
            backoffFunction: "arithmetic"
        disableSubscriptionOverrides: True
        defaultThrottlePolicy:
            maxReceivesPerSecond: 10
    subscriptions:
      - endpoint: "{{ item }}"
        protocol: "lambda"
  with_items: "{{ lambda_facts.function['update-s3-storage-prices'].function_arn }}"